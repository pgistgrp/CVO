<?xml version="1.0" encoding="UTF-8"?>
<statements>


    <drops>
    
        <statement exception="suppress">
            <description>drop view if exists</description>
            <script>
              <![CDATA[
                DROP VIEW view_post_reply_tags CASCADE;
              ]]>
            </script>
        </statement>
        
        <statement exception="suppress">
            <description>drop view if exists</description>
            <script>
              <![CDATA[
                DROP VIEW view_concern_tags CASCADE;
              ]]>
            </script>
        </statement>
        
        <statement exception="suppress">
            <description>drop view if exists</description>
            <script>
              <![CDATA[
                DROP VIEW view_info_structure_tags CASCADE;
              ]]>
            </script>
        </statement>
        
    </drops>
    
    
    <creates>
    
        <statement exception="throw">
            <description>view for isid-tagid link</description>
            <script>
              <![CDATA[
                CREATE VIEW view_info_structure_tags AS
                  SELECT DISTINCT s.id AS isid, l.tagref_id AS trid
                  FROM pgist_info_structure s, pgist_info_object o, pgist_cvo_category_refs cat, pgist_cvo_catref_tagref_link l
                  ORDER BY s.id, l.tagref_id;
              ]]>
            </script>
        </statement>
        
        <statement exception="throw">
            <description>view for concern-tagref-isid-ioid-cctid link</description>
            <script>
              <![CDATA[
                CREATE VIEW view_concern_tags AS
                  SELECT s.cctid as cctid, 0 as isid, 0 as ioid, c.id as cid, l.tagref_id as trid from pgist_info_structure s, pgist_cvo_concerns c, pgist_cvo_concern_tag_link l where s.cctid=c.cct_id and l.concern_id=c.id and l.tagref_id not in (select trid from view_info_structure_tags)
                  UNION
                  SELECT s.cctid as cctid, s.id as isid, o.id as ioid, c.id as cid, l.tagref_id as trid from pgist_info_structure s, pgist_info_object o, pgist_cvo_concerns c, pgist_cvo_concern_tag_link l where s.cctid=c.cct_id and o.structure_id=s.id and l.concern_id=c.id and l.tagref_id in (select trid from view_info_structure_tags);
              ]]>
            </script>
        </statement>
        
        <statement exception="throw">
            <description>view for post-reply-tags link</description>
            <script>
              <![CDATA[
                CREATE VIEW view_post_reply_tags AS
                  SELECT s.id AS isid, 0 AS ioid, d.id AS did, p.id AS pid, 0 AS rid, t.tag_id AS tid FROM pgist_discussion d, pgist_discussion_post p, pgist_dpost_tag_link t, pgist_info_structure s WHERE d.targetid=s.id and p.discussion_id=d.id and t.dpost_id=p.id
                UNION
                  SELECT s.id AS isid, o.id AS ioid, d.id AS did, p.id AS pid, 0 AS rid, t.tag_id AS tid FROM pgist_discussion d, pgist_discussion_post p, pgist_dpost_tag_link t, pgist_info_structure s, pgist_info_object o WHERE d.targetid=o.id and p.discussion_id=d.id and t.dpost_id=p.id and o.structure_id=s.id
                UNION
                  SELECT s.id AS isid, 0 AS ioid, d.id AS did, p.id AS pid, r.id AS rid, t.tag_id AS tid FROM pgist_discussion d, pgist_discussion_post p, pgist_discussion_reply r, pgist_dreply_tag_link t, pgist_info_structure s WHERE d.targetid=s.id and p.discussion_id=d.id and t.dreply_id=r.id and p.id=r.parent_id
                UNION
                  SELECT s.id AS isid, o.id AS ioid, d.id AS did, p.id AS pid, r.id AS rid, t.tag_id AS tid FROM pgist_discussion d, pgist_discussion_post p, pgist_discussion_reply r, pgist_dreply_tag_link t, pgist_info_structure s, pgist_info_object o WHERE d.targetid=o.id and p.discussion_id=d.id and t.dreply_id=r.id and o.structure_id=s.id and r.parent_id=p.id;
              ]]>
            </script>
        </statement>
        
    </creates>
    

</statements>

